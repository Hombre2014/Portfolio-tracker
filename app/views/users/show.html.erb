  <div class="container">
  <h1 class="text-center my-16 font-bold text-4xl">User profile</h1>
  <div class="w-full mx-auto flex justify-between", style="column-gap: 1rem;">
    <div class="flex flex-col w-1/3">
      <div class="max-w-16">Avatar
        <% if current_user.provider != 'google_oauth2' %>
          <div class="mx-0">
            <div><%= gravatar_for(current_user) %></div>
          </div>
        <% else %>
          <% if current_user.avatar_url %>
            <%= image_tag current_user.avatar_url, style: "max-width: 128px; hight: auto;" %>
          <% end %>
        <% end %>
        <span>Avatar can be changed on <%= link_to "Gravatar", "https://en.gravatar.com/emails/",  target: :'_blank', rel: :'noopener noreferrer', class:"text-dollar-split_blue font-bold hover:text-dollar-complement" %> or <%= link_to "Google", "https://myaccount.google.com/",  target: :'_blank', rel: :'noopener noreferrer', class:"text-dollar-split_blue font-bold hover:text-dollar-complement" %></span>
      </div>
      <span>Name <%= @user.name %></span>
      <span>Email <%= @user.email %></span>
      <%= link_to "Edit you credentials", edit_user_registration_path, class: "mt-12 rounded-lg py-1 px-3 bg-dollar-split_blue inline-block font-medium text-white hover:bg-dollar-triad_blue w-fit" %>
    </div>
    <div class="flex flex-col w-1/3">
      <% @winners_amount = {} %>
      <% @winners_percent = {} %>
      <% @loosers_percent = {} %>
      <% @portfolio_name = {} %>
      <% @loosers_amount = {} %>
      <% @winners = 0 %>
      <% @loosers = 0 %>
      <% @stats = {} %>
      <% @positions.each do |position| %>
        <% price = @finnhub_client.quote(position.symbol) %>
        <% position_cost = position.quantity * position.cost_per_share - position.reinvested_income %>
        <% position_value = (position.quantity * price.c).round(2) %>
        <% profit_loss = position_value - position_cost %>
        <% @stats.store('amount', profit_loss) %>
        <% portfolio_name = @portfolios.where(id: position.portfolio_id).pluck(:name)[0] %>
        <% @stats.store('portfolio_name', portfolio_name) %>
        <% @portfolio_name.store(position.symbol, @stats['portfolio_name']) %>
        <% if position.quantity < 0 %>
          <% @stats.store('percent', profit_loss / position_cost * -100) %>
        <% else %>
          <% @stats.store('percent', profit_loss / position_cost * 100) %>
        <% end %>
        <% @stats.store('percent', @stats['percent'].round(2)) %>
        
        <% if (profit_loss >= 0) %>
          <% @winners += 1 %>
          <% @winners_amount.store(position.symbol, @stats['amount']) %>
          <% @winners_percent.store(position.symbol, @stats['percent']) %>
        <% else %>
          <% @loosers += 1 %>
          <% @loosers_amount.store(position.symbol, @stats['amount']) %>
          <% @loosers_percent.store(position.symbol, @stats['percent']) %>
        <% end %>
      <% end %>
      <% position_cost = 0 %>
      <% position_value = 0 %>
      <% @winners_amount = @winners_amount.sort_by {|_key, amount| amount}.reverse.to_h %>
      <% @winners_amount = @winners_amount.first(3) %>
      <div>
        <h2 class="mb-2 text-lg font-medium">Top $ winning positions:</h2>
          <% @winners_amount.each do |key, position| %>
            <% if @winners > 0 %>
            <div class="flex", style="column-gap: 1rem;">
              <div class="flex justify-between w-1/3">
                <span><%= key %></span>
                <span class="text-green-600"><%= number_to_currency(position) %></span>
              </div>
              <div>
                <span class="text-600"><%= @portfolio_name[key] %></span>
              </div>
            </div>
            <% else %>
              <%= puts "You don't have any $ winners" %>
            <% end %>
          <% end %>
      </div>
      <% @winners_percent = @winners_percent.sort_by {|_key, percent| percent}.reverse.to_h %>
      <% @winners_percent = @winners_percent.first(3) %>
      <div>
        <h2 class="mb-2 text-lg font-medium mt-4">Top % winning positions:</h2>
          <% @winners_percent.each do |key, position| %>
            <% if @winners > 0 %>
            <div class="flex", style="column-gap: 1rem;">
              <div class="flex justify-between w-1/3">
                <span><%= key %></span>
                <span class="text-green-600"><%= number_to_percentage(position.round(2)).to_f %>%</span>
                
              </div>
              <div>
                <span class="text-600"><%= @portfolio_name[key] %></span>
              </div>
            </div>
            <% else %>
              <%= puts "You don't have any % winners" %>
            <% end %>
          <% end %>
      </div>
    </div>
    <div class="flex flex-col w-1/3">
      <div>
        <h2 class="mb-2 text-lg font-medium">Top $ loosing positions:</h2>
        <% @loosers_amount = @loosers_amount.sort_by {|_key, position| position}.to_h %>
          <% @loosers_amount = @loosers_amount.first(3) %>
          <% @loosers_amount.each do |key, position| %>
            <% if @loosers > 0 %>
              <div class="flex", style="column-gap: 1rem;">
                <div class="flex justify-between w-1/3">
                  <span><%= key %></span>
                  <span class="text-red-600"><%= number_to_currency(position) %></span>
                </div>
                <div>
                  <span class="text-600"><%= @portfolio_name[key] %></span>
                </div>
            </div>
            <% else %>
              <%= puts "You don't have any $ loosers" %>
            <% end %>
          <% end %> 
      </div>
      <div>
        <h2 class="mb-2 text-lg font-medium mt-4">Top % loosing positions:</h2>
        <% @loosers_percent = @loosers_percent.sort_by {|_key, position| position}.to_h %>
        <% @loosers_percent = @loosers_percent.first(3) %>
        <% @loosers_percent.each do |key, position| %>
          <% if @loosers > 0 %>
            <div class="flex", style="column-gap: 1rem;">
              <div class="flex justify-between w-1/3">
                <span><%= key %></span>
                <span class="text-red-600"><%= number_to_percentage(position.round(2)).to_f %>%</span>
              </div>
              <div>
                <span class="text-600"><%= @portfolio_name[key] %></span>
              </div>
          </div>
          <% else %>
            <%= puts "You don't have any % loosers" %>
          <% end %>
        <% end %>
    </div>
  </div>
</div>
